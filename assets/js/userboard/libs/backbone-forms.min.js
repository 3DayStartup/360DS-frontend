define(["jquery","underscore","backbone"],function(e,t,n){var r=function(){return n.View.extend({hasFocus:false,initialize:function(e){if(!r.templates.form)throw new Error("Templates not loaded");this.schema=function(){if(e.schema)return e.schema;var n=e.model;if(!n)throw new Error("Could not find schema");if(t.isFunction(n.schema))return n.schema();return n.schema}();e=t.extend({template:"form",fieldsetTemplate:"fieldset",fieldTemplate:"field"},e);if(!e.fieldsets){var n=e.fields||t.keys(this.schema);e.fieldsets=[{fields:n}]}this.options=e;this.model=e.model;this.data=e.data;this.fields={}},render:function(){var n=this,i=this.options,s=r.templates[i.template];var o=e(s({fieldsets:'<b class="bbf-tmp"></b>'}));var u=e(".bbf-tmp",o);t.each(i.fieldsets,function(e){u.append(n.renderFieldset(e))});u.children().unwrap();this.setElement(o);if(this.hasFocus)this.trigger("blur",this);return this},renderFieldset:function(n){var i=this,s=r.templates[this.options.fieldsetTemplate],o=this.schema,u=r.helpers.getNested;if(t.isArray(n)){n={fields:n}}var a=e(s(t.extend({},n,{legend:'<b class="bbf-tmp-legend"></b>',fields:'<b class="bbf-tmp-fields"></b>'})));if(n.legend){a.find(".bbf-tmp-legend").replaceWith(n.legend)}else{a.find(".bbf-tmp-legend").parent().remove()}var f=e(".bbf-tmp-fields",a);t.each(n.fields,function(e){var n=function(){if(o[e])return o[e];var t=e.replace(/\./g,".subSchema.");return u(o,t)}();if(!n)throw"Field '"+e+"' not found in schema";var r=i.fields[e]=i.createField(e,n);var s=r.render().el;r.editor.on("all",function(n){var r=t.toArray(arguments);r[0]=e+":"+n;r.splice(1,0,this);this.trigger.apply(this,r)},i);r.editor.on("change",function(){this.trigger("change",i)},i);r.editor.on("focus",function(){if(this.hasFocus)return;this.trigger("focus",this)},i);r.editor.on("blur",function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(t.find(e.fields,function(e){return e.editor.hasFocus}))return;e.trigger("blur",e)},0)},i);if(n.type!=="Hidden"){f.append(s)}});f=f.children().unwrap();return a},createField:function(e,t){t.template=t.template||this.options.fieldTemplate;var n={form:this,key:e,schema:t,idPrefix:this.options.idPrefix,template:this.options.fieldTemplate};if(this.model){n.model=this.model}else if(this.data){n.value=this.data[e]}else{n.value=null}return new r.Field(n)},validate:function(){var e=this,n=this.fields,r=this.model,i={};t.each(n,function(e){var t=e.validate();if(t){i[e.key]=t}});if(r&&r.validate){var s=r.validate(this.getValue());if(s){var o=t.isObject(s)&&!t.isArray(s);if(!o){i._others=i._others||[];i._others.push(s)}if(o){t.each(s,function(t,n){if(e.fields[n]&&!i[n]){e.fields[n].setError(t);i[n]=t}else{i._others=i._others||[];var r={};r[n]=t;i._others.push(r)}})}}}return t.isEmpty(i)?null:i},commit:function(){var e=this.validate();if(e)return e;var t;this.model.set(this.getValue(),{error:function(e,n){t=n}});if(t)return t},getValue:function(e){if(e)return this.fields[e].getValue();var n={};t.each(this.fields,function(e){n[e.key]=e.getValue()});return n},setValue:function(e,t){var n={};if(typeof e==="string"){n[e]=t}else{n=e}var r;for(r in this.schema){if(n[r]!==undefined){this.fields[r].setValue(n[r])}}},focus:function(){if(this.hasFocus)return;var e=this.options.fieldsets[0];if(e){var n;if(t.isArray(e)){n=e[0]}else{n=e.fields[0]}if(n){this.fields[n].editor.focus()}}},blur:function(){if(!this.hasFocus)return;var e=t.find(this.fields,function(e){return e.editor.hasFocus});if(e)e.editor.blur()},remove:function(){var e=this.fields;for(var t in e){e[t].remove()}n.View.prototype.remove.call(this)},trigger:function(e){if(e==="focus"){this.hasFocus=true}else if(e==="blur"){this.hasFocus=false}return n.View.prototype.trigger.apply(this,arguments)}})}();r.helpers=function(){var n={};n.getNested=function(e,t){var n=t.split(".");var r=e;for(var i=0,s=n.length;i<s;i++){r=r[n[i]]}return r};n.keyToTitle=function(e){e=e.replace(/([A-Z])/g," $1");e=e.replace(/^./,function(e){return e.toUpperCase()});return e};n.compileTemplate=function(e){var n=t.templateSettings.interpolate;t.templateSettings.interpolate=/\{\{(.+?)\}\}/g;var r=t.template(e);t.templateSettings.interpolate=n;return r};n.createTemplate=function(t,r){var i=n.compileTemplate(e.trim(t));if(!r){return i}else{return i(r)}};n.setTemplateCompiler=function(e){n.compileTemplate=e};n.setTemplates=function(e,i){var s=n.createTemplate;r.templates=r.templates||{};r.classNames=r.classNames||{};t.each(e,function(e,n,i){if(t.isString(e))e=s(e);r.templates[n]=e});t.extend(r.classNames,i)};n.createEditor=function(e,n){var i;if(t.isString(e)){i=r.editors[e]}else{i=e}return new i(n)};n.getValidator=function(e){var n=r.validators;if(t.isRegExp(e)){return n.regexp({regexp:e})}if(t.isString(e)){if(!n[e])throw new Error('Validator "'+e+'" not found');return n[e]()}if(t.isFunction(e))return e;if(t.isObject(e)&&e.type){var i=e;return n[i.type](i)}throw new Error("Invalid validator: "+e)};return n}();r.validators=function(){var e={};e.errMessages={required:"Required",regexp:"Invalid",email:"Invalid email address",url:"Invalid URL",match:'Must match field "{{field}}"'};e.required=function(e){e=t.extend({type:"required",message:this.errMessages.required},e);return function(n){e.value=n;var i={type:e.type,message:r.helpers.createTemplate(e.message,e)};if(n===null||n===undefined||n===false||n==="")return i}};e.regexp=function(e){if(!e.regexp)throw new Error('Missing required "regexp" option for "regexp" validator');e=t.extend({type:"regexp",message:this.errMessages.regexp},e);return function(n){e.value=n;var i={type:e.type,message:r.helpers.createTemplate(e.message,e)};if(n===null||n===undefined||n==="")return;if(!e.regexp.test(n))return i}};e.email=function(n){n=t.extend({type:"email",message:this.errMessages.email,regexp:/^[\w\-]{1,}([\w\-\+.]{1,1}[\w\-]{1,}){0,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/},n);return e.regexp(n)};e.url=function(n){n=t.extend({type:"url",message:this.errMessages.url,regexp:/^(http|https):\/\/(([A-Z0-9][A-Z0-9_\-]*)(\.[A-Z0-9][A-Z0-9_\-]*)+)(:(\d+))?\/?/i},n);return e.regexp(n)};e.match=function(e){if(!e.field)throw new Error('Missing required "field" options for "match" validator');e=t.extend({type:"match",message:this.errMessages.match},e);return function(n,i){e.value=n;var s={type:e.type,message:r.helpers.createTemplate(e.message,e)};if(n===null||n===undefined||n==="")return;if(n!==i[e.field])return s}};return e}();r.Field=function(){var i=r.helpers,s=r.templates;return n.View.extend({initialize:function(e){e=e||{};this.form=e.form;this.key=e.key;this.value=e.value;this.model=e.model;if(t.isString(e.schema))e.schema={type:e.schema};this.schema=t.extend({type:"Text",title:i.keyToTitle(this.key),template:"field"},e.schema)},renderingContext:function(e,t){return{key:this.key,title:e.title,id:t.id,type:e.type,editor:'<b class="bbf-tmp-editor"></b>',help:'<b class="bbf-tmp-help"></b>',error:'<b class="bbf-tmp-error"></b>'}},render:function(){var t=this.schema,n=r.templates;var s={form:this.form,key:this.key,schema:t,idPrefix:this.options.idPrefix,id:this.getId()};if(this.model){s.model=this.model}else{s.value=this.value}var o=this.editor=i.createEditor(t.type,s);var u=e(n[t.template](this.renderingContext(t,o)));if(t.title===false){u.find('label[for="'+o.id+'"]').first().remove()}u.find(".bbf-tmp-editor").replaceWith(o.render().el);this.$help=e(".bbf-tmp-help",u).parent();this.$help.empty();if(this.schema.help)this.$help.html(this.schema.help);this.$error=e(e(".bbf-tmp-error",u).parent()[0]);if(this.$error)this.$error.empty();if(this.schema.fieldClass)u.addClass(this.schema.fieldClass);if(this.schema.fieldAttrs)u.attr(this.schema.fieldAttrs);this.setElement(u);return this},getId:function(){var e=this.options.idPrefix,n=this.key;n=n.replace(/\./g,"_");if(t.isString(e)||t.isNumber(e))return e+n;if(t.isNull(e))return n;if(this.model)return this.model.cid+"_"+n;return n},validate:function(){var e=this.editor.validate();if(e){this.setError(e.message)}else{this.clearError()}return e},setError:function(e){if(this.editor.hasNestedForm)return;var t=r.classNames.error;this.$el.addClass(t);if(this.$error){this.$error.html(e)}else if(this.$help){this.$help.html(e)}},clearError:function(){var e=r.classNames.error;this.$el.removeClass(e);if(this.$error){this.$error.empty()}else if(this.$help){this.$help.empty();var t=this.schema.help;if(t)this.$help.html(t)}},commit:function(){return this.editor.commit()},getValue:function(){return this.editor.getValue()},setValue:function(e){this.editor.setValue(e)},focus:function(){this.editor.focus()},blur:function(){this.editor.blur()},remove:function(){this.editor.remove();n.View.prototype.remove.call(this)}})}();r.editors=function(){var i=r.helpers;var s={};s.Base=n.View.extend({defaultValue:null,hasFocus:false,initialize:function(e){var e=e||{};if(e.model){if(!e.key)throw"Missing option: 'key'";this.model=e.model;this.value=this.model.get(e.key)}else if(e.value){this.value=e.value}if(this.value===undefined)this.value=this.defaultValue;this.key=e.key;this.form=e.form;this.schema=e.schema||{};this.validators=e.validators||this.schema.validators;this.$el.attr("name",this.getName());if(this.schema.editorClass)this.$el.addClass(this.schema.editorClass);if(this.schema.editorAttrs)this.$el.attr(this.schema.editorAttrs)},getValue:function(){throw"Not implemented. Extend and override this method."},setValue:function(){throw"Not implemented. Extend and override this method."},focus:function(){throw"Not implemented. Extend and override this method."},blur:function(){throw"Not implemented. Extend and override this method."},getName:function(){var e=this.key||"";return e.replace(/\./g,"_")},commit:function(e){var t=this.validate();if(t)return t;this.listenTo(this.model,"invalid",function(e,n){t=n});this.model.set(this.key,this.getValue(),e);if(t)return t},validate:function(){var e=this.$el,n=null,i=this.getValue(),s=this.form?this.form.getValue():{},o=this.validators,u=r.helpers.getValidator;if(o){t.every(o,function(e){n=u(e)(i,s);return n?false:true})}return n},trigger:function(e){if(e==="focus"){this.hasFocus=true}else if(e==="blur"){this.hasFocus=false}return n.View.prototype.trigger.apply(this,arguments)}});s.Text=s.Base.extend({tagName:"input",defaultValue:"",previousValue:"",events:{keyup:"determineChange",keypress:function(e){var t=this;setTimeout(function(){t.determineChange()},0)},select:function(e){this.trigger("select",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("blur",this)}},initialize:function(e){s.Base.prototype.initialize.call(this,e);var t=this.schema;var n="text";if(t&&t.editorAttrs&&t.editorAttrs.type)n=t.editorAttrs.type;if(t&&t.dataType)n=t.dataType;this.$el.attr("type",n)},render:function(){this.setValue(this.value);return this},determineChange:function(e){var t=this.$el.val();var n=t!==this.previousValue;if(n){this.previousValue=t;this.trigger("change",this)}},getValue:function(){return this.$el.val()},setValue:function(e){this.$el.val(e)},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},select:function(){this.$el.select()}});s.Number=s.Text.extend({defaultValue:0,events:t.extend({},s.Text.prototype.events,{keypress:"onKeyPress"}),initialize:function(e){s.Text.prototype.initialize.call(this,e);this.$el.attr("type","number");this.$el.attr("step","any")},onKeyPress:function(e){var t=this,n=function(){setTimeout(function(){t.determineChange()},0)};if(e.charCode===0){n();return}var r=this.$el.val()+String.fromCharCode(e.charCode);var i=/^[0-9]*\.?[0-9]*?$/.test(r);if(i){n()}else{e.preventDefault()}},getValue:function(){var e=this.$el.val();return e===""?null:parseFloat(e,10)},setValue:function(e){e=function(){if(t.isNumber(e))return e;if(t.isString(e)&&e!=="")return parseFloat(e,10);return null}();if(t.isNaN(e))e=null;s.Text.prototype.setValue.call(this,e)}});s.Password=s.Text.extend({initialize:function(e){s.Text.prototype.initialize.call(this,e);this.$el.attr("type","password")}});s.TextArea=s.Text.extend({tagName:"textarea"});s.Checkbox=s.Base.extend({defaultValue:false,tagName:"input",events:{click:function(e){this.trigger("change",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("blur",this)}},initialize:function(e){s.Base.prototype.initialize.call(this,e);this.$el.attr("type","checkbox")},render:function(){this.setValue(this.value);return this},getValue:function(){return this.$el.prop("checked")},setValue:function(e){if(e){this.$el.prop("checked",true)}},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()}});s.Hidden=s.Base.extend({defaultValue:"",initialize:function(e){s.Text.prototype.initialize.call(this,e);this.$el.attr("type","hidden")},getValue:function(){return this.value},setValue:function(e){this.value=e},focus:function(){},blur:function(){}});s.Select=s.Base.extend({tagName:"select",events:{change:function(e){this.trigger("change",this)},focus:function(e){this.trigger("focus",this)},blur:function(e){this.trigger("blur",this)}},initialize:function(e){s.Base.prototype.initialize.call(this,e);if(!this.schema||!this.schema.options)throw"Missing required 'schema.options'"},render:function(){this.setOptions(this.schema.options);return this},setOptions:function(e){var r=this;if(e instanceof n.Collection){var i=e;if(i.length>0){this.renderOptions(e)}else{i.fetch({success:function(t){r.renderOptions(e)}})}}else if(t.isFunction(e)){e(function(e){r.renderOptions(e)},r)}else{this.renderOptions(e)}},renderOptions:function(e){var r=this.$el,i;if(t.isString(e)){i=e}else if(t.isArray(e)){i=this._arrayToHtml(e)}else if(e instanceof n.Collection){i=this._collectionToHtml(e)}r.html(i);this.setValue(this.value)},getValue:function(){return this.$el.val()},setValue:function(e){this.$el.val(e)},focus:function(){if(this.hasFocus)return;this.$el.focus()},blur:function(){if(!this.hasFocus)return;this.$el.blur()},_collectionToHtml:function(e){var t=[];e.each(function(e){t.push({val:e.id,label:e.toString()})});var n=this._arrayToHtml(t);return n},_arrayToHtml:function(e){var n=[];t.each(e,function(e){if(t.isObject(e)){var r=e.val||e.val===0?e.val:"";n.push('<option value="'+r+'">'+e.label+"</option>")}else{n.push("<option>"+e+"</option>")}});return n.join("")}});s.Radio=s.Select.extend({tagName:"ul",className:"bbf-radio",events:{"change input[type=radio]":function(){this.trigger("change",this)},"focus input[type=radio]":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur input[type=radio]":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("input[type=radio]:focus")[0])return;e.trigger("blur",e)},0)}},getValue:function(){return this.$("input[type=radio]:checked").val()},setValue:function(e){this.$("input[type=radio]").val([e])},focus:function(){if(this.hasFocus)return;var e=this.$("input[type=radio]:checked");if(e[0]){e.focus();return}this.$("input[type=radio]").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("input[type=radio]:focus").blur()},_arrayToHtml:function(e){var n=[];var r=this;t.each(e,function(e,i){var s="<li>";if(t.isObject(e)){var o=e.val||e.val===0?e.val:"";s+='<input type="radio" name="'+r.id+'" value="'+o+'" id="'+r.id+"-"+i+'" />';s+='<label for="'+r.id+"-"+i+'">'+e.label+"</label>"}else{s+='<input type="radio" name="'+r.id+'" value="'+e+'" id="'+r.id+"-"+i+'" />';s+='<label for="'+r.id+"-"+i+'">'+e+"</label>"}s+="</li>";n.push(s)});return n.join("")}});s.Checkboxes=s.Select.extend({tagName:"ul",className:"bbf-checkboxes",events:{"click input[type=checkbox]":function(){this.trigger("change",this)},"focus input[type=checkbox]":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur input[type=checkbox]":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("input[type=checkbox]:focus")[0])return;e.trigger("blur",e)},0)}},getValue:function(){var t=[];this.$("input[type=checkbox]:checked").each(function(){t.push(e(this).val())});return t},setValue:function(e){if(!t.isArray(e))e=[e];this.$("input[type=checkbox]").val(e)},focus:function(){if(this.hasFocus)return;this.$("input[type=checkbox]").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("input[type=checkbox]:focus").blur()},_arrayToHtml:function(e){var n=[];var r=this;t.each(e,function(e,i){var s="<li>";if(t.isObject(e)){var o=e.val||e.val===0?e.val:"";s+='<input type="checkbox" name="'+r.id+'" value="'+o+'" id="'+r.id+"-"+i+'" />';s+='<label for="'+r.id+"-"+i+'">'+e.label+"</label>"}else{s+='<input type="checkbox" name="'+r.id+'" value="'+e+'" id="'+r.id+"-"+i+'" />';s+='<label for="'+r.id+"-"+i+'">'+e+"</label>"}s+="</li>";n.push(s)});return n.join("")}});s.Object=s.Base.extend({hasNestedForm:true,className:"bbf-object",initialize:function(e){this.value={};s.Base.prototype.initialize.call(this,e);if(!this.schema.subSchema)throw new Error("Missing required 'schema.subSchema' option for Object editor")},render:function(){this.form=new r({schema:this.schema.subSchema,data:this.value,idPrefix:this.id+"_",fieldTemplate:"nestedField"});this._observeFormEvents();this.$el.html(this.form.render().el);if(this.hasFocus)this.trigger("blur",this);return this},getValue:function(){if(this.form)return this.form.getValue();return this.value},setValue:function(e){this.value=e;this.render()},focus:function(){if(this.hasFocus)return;this.form.focus()},blur:function(){if(!this.hasFocus)return;this.form.blur()},remove:function(){this.form.remove();n.View.prototype.remove.call(this)},validate:function(){return this.form.validate()},_observeFormEvents:function(){this.form.on("all",function(){var e=t.toArray(arguments);e[1]=this;this.trigger.apply(this,e)},this)}});s.NestedModel=s.Object.extend({initialize:function(e){s.Base.prototype.initialize.call(this,e);if(!e.schema.model)throw'Missing required "schema.model" option for NestedModel editor'},render:function(){var e=this.value||{},t=this.key,n=this.schema.model;var i=e.constructor===n?e:new n(e);this.form=new r({model:i,idPrefix:this.id+"_",fieldTemplate:"nestedField"});this._observeFormEvents();this.$el.html(this.form.render().el);if(this.hasFocus)this.trigger("blur",this);return this},commit:function(){var e=this.form.commit();if(e){this.$el.addClass("error");return e}return s.Object.prototype.commit.call(this)}});s.Date=s.Base.extend({events:{"change select":function(){this.updateHidden();this.trigger("change",this)},"focus select":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur select":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("select:focus")[0])return;e.trigger("blur",e)},0)}},initialize:function(e){e=e||{};s.Base.prototype.initialize.call(this,e);var n=s.Date,r=new Date;this.options=t.extend({monthNames:n.monthNames,showMonthNames:n.showMonthNames},e);this.schema=t.extend({yearStart:r.getFullYear()-100,yearEnd:r.getFullYear()},e.schema||{});if(this.value&&!t.isDate(this.value)){this.value=new Date(this.value)}if(!this.value){var i=new Date;i.setSeconds(0);i.setMilliseconds(0);this.value=i}},render:function(){var n=this.options,i=this.schema;var s=t.map(t.range(1,32),function(e){return'<option value="'+e+'">'+e+"</option>"});var o=t.map(t.range(0,12),function(e){var t=n.showMonthNames?n.monthNames[e]:e+1;return'<option value="'+e+'">'+t+"</option>"});var u=i.yearStart<i.yearEnd?t.range(i.yearStart,i.yearEnd+1):t.range(i.yearStart,i.yearEnd-1,-1);var a=t.map(u,function(e){return'<option value="'+e+'">'+e+"</option>"});var f=e(r.templates.date({dates:s.join(""),months:o.join(""),years:a.join("")}));this.$date=f.find('select[data-type="date"]');this.$month=f.find('select[data-type="month"]');this.$year=f.find('select[data-type="year"]');this.$hidden=e('<input type="hidden" name="'+this.key+'" />');f.append(this.$hidden);this.setValue(this.value);this.setElement(f);this.$el.attr("id",this.id);if(this.hasFocus)this.trigger("blur",this);return this},getValue:function(){var e=this.$year.val(),t=this.$month.val(),n=this.$date.val();if(!e||!t||!n)return null;return new Date(e,t,n)},setValue:function(e){this.$date.val(e.getDate());this.$month.val(e.getMonth());this.$year.val(e.getFullYear());this.updateHidden()},focus:function(){if(this.hasFocus)return;this.$("select").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("select:focus").blur()},updateHidden:function(){var e=this.getValue();if(t.isDate(e))e=e.toISOString();this.$hidden.val(e)}},{showMonthNames:true,monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"]});s.DateTime=s.Base.extend({events:{"change select":function(){this.updateHidden();this.trigger("change",this)},"focus select":function(){if(this.hasFocus)return;this.trigger("focus",this)},"blur select":function(){if(!this.hasFocus)return;var e=this;setTimeout(function(){if(e.$("select:focus")[0])return;e.trigger("blur",e)},0)}},initialize:function(e){e=e||{};s.Base.prototype.initialize.call(this,e);this.options=t.extend({DateEditor:s.DateTime.DateEditor},e);this.schema=t.extend({minsInterval:15},e.schema||{});this.dateEditor=new this.options.DateEditor(e);this.value=this.dateEditor.value},render:function(){function n(e){return e<10?"0"+e:e}var i=this.schema;var s=t.map(t.range(0,24),function(e){return'<option value="'+e+'">'+n(e)+"</option>"});var o=t.map(t.range(0,60,i.minsInterval),function(e){return'<option value="'+e+'">'+n(e)+"</option>"});var u=e(r.templates.dateTime({date:'<b class="bbf-tmp"></b>',hours:s.join(),mins:o.join()}));u.find(".bbf-tmp").replaceWith(this.dateEditor.render().el);this.$hour=u.find('select[data-type="hour"]');this.$min=u.find('select[data-type="min"]');this.$hidden=u.find('input[type="hidden"]');this.setValue(this.value);this.setElement(u);this.$el.attr("id",this.id);if(this.hasFocus)this.trigger("blur",this);return this},getValue:function(){var e=this.dateEditor.getValue();var t=this.$hour.val(),n=this.$min.val();if(!e||!t||!n)return null;e.setHours(t);e.setMinutes(n);return e},setValue:function(e){if(!t.isDate(e))e=new Date(e);this.dateEditor.setValue(e);this.$hour.val(e.getHours());this.$min.val(e.getMinutes());this.updateHidden()},focus:function(){if(this.hasFocus)return;this.$("select").first().focus()},blur:function(){if(!this.hasFocus)return;this.$("select:focus").blur()},updateHidden:function(){var e=this.getValue();if(t.isDate(e))e=e.toISOString();this.$hidden.val(e)},remove:function(){this.dateEditor.remove();s.Base.prototype.remove.call(this)}},{DateEditor:s.Date});return s}();r.setTemplates=r.helpers.setTemplates;r.setTemplateCompiler=r.helpers.setTemplateCompiler;r.templates={};r.setTemplates({form:'        <form class="form-horizontal">{{fieldsets}}</form>      ',fieldset:"        <fieldset>          <legend>{{legend}}</legend>          {{fields}}        </fieldset>      ",field:'        <div class="control-group field-{{key}}">          <label class="control-label" for="{{id}}">{{title}}</label>          <div class="controls">            {{editor}}            <div class="help-inline">{{error}}</div>            <div class="help-block">{{help}}</div>          </div>        </div>      ',nestedField:'        <div class="field-{{key}}">          <div title="{{title}}" class="input-xlarge">{{editor}}            <div class="help-inline">{{error}}</div>          </div>          <div class="help-block">{{help}}</div>        </div>      ',list:'        <div class="bbf-list">          <ul class="unstyled clearfix">{{items}}</ul>          <button class="btn bbf-add" data-action="add">Add</button>        </div>      ',listItem:'        <li class="clearfix">          <div class="pull-left">{{editor}}</div>          <button type="button" class="btn bbf-del" data-action="remove">×</button>        </li>      ',date:'        <div class="bbf-date">          <select data-type="date" class="bbf-date">{{dates}}</select>          <select data-type="month" class="bbf-month">{{months}}</select>          <select data-type="year" class="bbf-year">{{years}}</select>        </div>      ',dateTime:'        <div class="bbf-datetime">          <p>{{date}}</p>          <p>            <select data-type="hour" style="width: 4em">{{hours}}</select>            :            <select data-type="min" style="width: 4em">{{mins}}</select>          </p>        </div>      ',"list.Modal":'        <div class="bbf-list-modal">          {{summary}}        </div>      '},{error:"error"});r.VERSION="0.11.0";n.Form=r;return r})